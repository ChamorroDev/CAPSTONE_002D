{% extends 'base.html' %}
{% load static %}

{% block title %}Iniciar Sesión - Junta de Vecinos{% endblock %}

{% block content %}
<script src="{% static 'js/login/login.js' %}"></script>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white text-center py-4">
                    <h3 class="mb-0">
                        <i class="bi bi-house-heart"></i> Junta de Vecinos
                    </h3>
                    <p class="mb-0">Iniciar Sesión</p>
                </div>
                
                <div class="card-body p-5">
                    <form id="loginForm">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label for="email" class="form-label">Correo Electrónico</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-envelope"></i>
                                </span>
                                <input type="email" class="form-control" id="email" 
                                       placeholder="tu@email.com" required>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="password" class="form-label">Contraseña</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-lock"></i>
                                </span>
                                <input type="password" class="form-control" id="password" 
                                       placeholder="Tu contraseña" required>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="loginBtn">
                                <span id="loginText">Iniciar Sesión</span>
                                <div id="loginSpinner" class="spinner-border spinner-border-sm d-none" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </button>
                        </div>
                    </form>
                    <div class="text-center mt-4">
                        <p class="mb-0">
                            ¿Olvidaste tu clave? 
                            <a href="{% url 'recuperar_password' %}" class="text-decoration-none">
                                Recupera tu clave aquí
                            </a>
                        </p>
                    </div>
                    
                    <div class="text-center mt-4">
                        <p class="mb-0">
                            ¿No tienes cuenta? 
                            <a href="{% url 'registro_vecino' %}" class="text-decoration-none">
                                Regístrate aquí
                            </a>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Alertas -->
            <div id="loginAlert" class="alert alert-danger mt-3 d-none" role="alert"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class LoginManager {
    constructor() {
        this.form = document.getElementById('loginForm');
        this.loginBtn = document.getElementById('loginBtn');
        this.loginText = document.getElementById('loginText');
        this.loginSpinner = document.getElementById('loginSpinner');
        this.alert = document.getElementById('loginAlert');
        
        this.init();
    }

    init() {
        this.form.addEventListener('submit', (e) => this.handleLogin(e));
        
        // Verificar si ya está autenticado
        if (checkAuthentication()) {
            const userRole = localStorage.getItem('user_role');
            redirectByRole(userRole);
        }
    }

    async handleLogin(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        if (!email || !password) {
            this.showAlert('Por favor, complete todos los campos');
            return;
        }

        this.setLoading(true);

        try {
            const result = await login(email, password);
            
            if (result.success) {
                this.showAlert('¡Login exitoso! Redirigiendo...', 'success');
                setTimeout(() => {
                    redirectByRole(result.data.user.rol);
                }, 1000);
            } else {
                this.showAlert(result.error);
            }
        } catch (error) {
            this.showAlert('Error de conexión. Intente nuevamente.');
        } finally {
            this.setLoading(false);
        }
    }

    setLoading(loading) {
        if (loading) {
            this.loginText.classList.add('d-none');
            this.loginSpinner.classList.remove('d-none');
            this.loginBtn.disabled = true;
        } else {
            this.loginText.classList.remove('d-none');
            this.loginSpinner.classList.add('d-none');
            this.loginBtn.disabled = false;
        }
    }

    showAlert(message, type = 'danger') {
        this.alert.textContent = message;
        this.alert.className = `alert alert-${type} mt-3`;
        this.alert.classList.remove('d-none');
        
        setTimeout(() => {
            this.alert.classList.add('d-none');
        }, 5000);
    }
}

// Inicializar login
document.addEventListener('DOMContentLoaded', function() {
    new LoginManager();
});
</script>
{% endblock %}